
========== NATURAL LANGUAGE QUERY ==========
List the top 5 customers by total credit

========== INTENT & ENTITIES ==========
- Intent: Rank entities (customers) by an aggregate metric
- Entities:
  - Entity type: customer
  - Metric: total credit
  - Aggregation: sum
  - Order: descending (top)
  - Limit: 5
  - Group by: customer
  - Filters: none specified
  - Time range: not specified
  - Output fields: customer, total credit

========== SQL GENERATION REASONING ==========
- Entities mapping: “customer” → CompanyName; “total credit” → sum of PrincipalAmount (exposure).
- Tables/Joins: Use dbo.vw_LoanPortfolio as primary source. Optionally join ref.FXRateDaily to normalize amounts to USD if loans span multiple currencies (join on CurrencyCode=FromCurrency, ToCurrency='USD', using latest RateDate per currency).
- Aggregations: Sum PrincipalAmount (or FX-converted amount) grouped by CompanyName to get total credit per customer.
- Filters: None specified; no date filter. Optionally exclude non-active loans (e.g., Status IN ('Active','Current')) if only current exposure is desired.
- Order/Limit: Sort by total credit descending; return top 5 customers.
- Assumptions: PrincipalAmount in vw_LoanPortfolio represents the credit exposure to aggregate. If currencies vary, convert to USD using the most recent available FX rate; otherwise, assume a single currency or specify a CurrencyCode filter.

========== GENERATED SQL (RAW) ==========
SELECT TOP (5)
    lp.CompanyName AS customer,
    SUM(lp.PrincipalAmount) AS total_credit
FROM dbo.vw_LoanPortfolio AS lp
GROUP BY lp.CompanyName
ORDER BY SUM(lp.PrincipalAmount) DESC

========== SQL QUERY RESULTS (TABLE) ==========
customer               | total_credit
-----------------------+-------------
Blue Ridge Energy Corp | 25000000.00 
Toronto Health Devices | 25000000.00 
Mumbai InfraTech Ltd   | 22000000.00 
Osaka Precision K.K.   | 22000000.00 
Shanghai GreenChem Co  | 22000000.00 

========== TOKEN USAGE & COST ==========
Input tokens: 2369
Completion tokens: 2348
Total tokens: 4717
Estimated cost (USD): 0.026441  [input=0.002961, output=0.023480; per-1k: in=0.00125, out=0.01; source=file:azure_openai_pricing.json]

========== RUN DURATION ==========
Run duration: 74.80 seconds

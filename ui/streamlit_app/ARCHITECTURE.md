# Multi-Model NL2SQL Architecture

## ğŸ—ï¸ System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER INTERFACE                              â”‚
â”‚                      (Streamlit Web App)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Example Questions (12 quick-start buttons)                â”‚  â”‚
â”‚  â”‚  â€¢ Text Input Area                                           â”‚  â”‚
â”‚  â”‚  â€¢ Model Selection (gpt-4.1 vs gpt-5-mini)                  â”‚  â”‚
â”‚  â”‚  â€¢ Control Toggles (Skip exec, Explain-only, No reasoning)  â”‚  â”‚
â”‚  â”‚  â€¢ Run Button                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MULTI-MODEL PIPELINE                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 1: INTENT EXTRACTION                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Model: gpt-4o-mini                                        â”‚  â”‚
â”‚  â”‚  Cost: $0.00015 per 1K input tokens                       â”‚  â”‚
â”‚  â”‚  Purpose: Parse natural language â†’ structured intent       â”‚  â”‚
â”‚  â”‚  Input: User question + schema context                     â”‚  â”‚
â”‚  â”‚  Output: JSON with intent, entities, filters, etc.         â”‚  â”‚
â”‚  â”‚  Typical Tokens: ~1,500 (mostly input)                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 2 (Optional): REASONING                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Model: Selected model (gpt-4.1 or gpt-5-mini)           â”‚  â”‚
â”‚  â”‚  Purpose: Explain high-level query plan                   â”‚  â”‚
â”‚  â”‚  Input: Intent + schema                                    â”‚  â”‚
â”‚  â”‚  Output: Natural language explanation                      â”‚  â”‚
â”‚  â”‚  Typical Tokens: ~2,000                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 3: SQL GENERATION                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Model: USER SELECTED                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Option A: gpt-4.1       â”‚  Option B: gpt-5-mini    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Cost: $0.00277/1K in    â”‚  Cost: $0.0003/1K in     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Best: Complex queries    â”‚  Best: Simple queries    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Accuracy: Highest        â”‚  Speed: Faster           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  Purpose: Generate accurate T-SQL query                   â”‚  â”‚
â”‚  â”‚  Input: Intent + full schema context                      â”‚  â”‚
â”‚  â”‚  Output: T-SQL with proper syntax, JOINs, etc.           â”‚  â”‚
â”‚  â”‚  Typical Tokens: ~4,000 (large schema context)           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQL SANITIZATION & EXTRACTION                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Extract SQL from markdown code blocks                  â”‚  â”‚
â”‚  â”‚  â€¢ Remove comments and explanation text                   â”‚  â”‚
â”‚  â”‚  â€¢ Validate basic syntax                                   â”‚  â”‚
â”‚  â”‚  â€¢ Add safety warnings if needed                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQL EXECUTION                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Database: Azure SQL Database (CONTOSO-FI)                â”‚  â”‚
â”‚  â”‚  Driver: pyodbc with ODBC Driver 18                        â”‚  â”‚
â”‚  â”‚  Security: Encrypted connection, SQL auth                  â”‚  â”‚
â”‚  â”‚  Output: List of dictionaries (rows)                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 4: RESULT FORMATTING                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Model: gpt-4.1-mini                                       â”‚  â”‚
â”‚  â”‚  Cost: $0.00055 per 1K input tokens                       â”‚  â”‚
â”‚  â”‚  Purpose: Create natural language summary                  â”‚  â”‚
â”‚  â”‚  Input: Question + SQL + results (first 20 rows)          â”‚  â”‚
â”‚  â”‚  Output: Professional summary with insights                â”‚  â”‚
â”‚  â”‚  Typical Tokens: ~2,500                                    â”‚  â”‚
â”‚  â”‚  Features:                                                  â”‚  â”‚
â”‚  â”‚    â€¢ Key findings highlighted                              â”‚  â”‚
â”‚  â”‚    â€¢ Statistics and patterns identified                    â”‚  â”‚
â”‚  â”‚    â€¢ Natural language answer to original question          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RESULTS PRESENTATION                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. Intent & Entities (from Stage 1)                        â”‚  â”‚
â”‚  â”‚  2. Reasoning (optional, from Stage 2)                      â”‚  â”‚
â”‚  â”‚  3. Generated SQL (from Stage 3)                            â”‚  â”‚
â”‚  â”‚  4. Data Table (interactive, sortable)                      â”‚  â”‚
â”‚  â”‚  5. AI Summary (from Stage 4) â­ NEW!                       â”‚  â”‚
â”‚  â”‚  6. Export Options (CSV, Excel, Copy SQL)                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              TOKEN USAGE & COST BREAKDOWN                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PER-STAGE METRICS:                                          â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  ğŸ¯ Intent (gpt-4o-mini)                                     â”‚  â”‚
â”‚  â”‚     Input: 256 tokens    Output: 128 tokens                 â”‚  â”‚
â”‚  â”‚     Cost: $0.000384                                          â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  ğŸ§  SQL (gpt-4.1)                                            â”‚  â”‚
â”‚  â”‚     Input: 2,048 tokens  Output: 512 tokens                 â”‚  â”‚
â”‚  â”‚     Cost: $0.011344                                          â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  ğŸ“ Formatting (gpt-4.1-mini)                                â”‚  â”‚
â”‚  â”‚     Input: 1,024 tokens  Output: 256 tokens                 â”‚  â”‚
â”‚  â”‚     Cost: $0.001126                                          â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  TOTAL: 4,224 tokens, $0.012854 USD                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       LOGGING & PERSISTENCE                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  File: RESULTS/nl2sql_multimodel_run_YYYYMMDD_HHMMSS.txt    â”‚  â”‚
â”‚  â”‚  Contains:                                                    â”‚  â”‚
â”‚  â”‚    â€¢ User question                                           â”‚  â”‚
â”‚  â”‚    â€¢ Intent & entities                                       â”‚  â”‚
â”‚  â”‚    â€¢ Reasoning (if enabled)                                  â”‚  â”‚
â”‚  â”‚    â€¢ Generated SQL                                           â”‚  â”‚
â”‚  â”‚    â€¢ Query results (JSON)                                    â”‚  â”‚
â”‚  â”‚    â€¢ AI summary                                              â”‚  â”‚
â”‚  â”‚    â€¢ Per-model token usage and costs                        â”‚  â”‚
â”‚  â”‚    â€¢ Elapsed time                                            â”‚  â”‚
â”‚  â”‚    â€¢ Model configuration used                                â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Optional: Upload to Azure Blob Storage                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Data Flow

```
User Question
    â”‚
    â”œâ”€â†’ + Schema Context â”€â†’ gpt-4o-mini â”€â†’ Intent/Entities
    â”‚                                          â”‚
    â”‚                                          â–¼
    â””â”€â†’ + Schema Context + Intent â”€â†’ gpt-4.1/gpt-5-mini â”€â†’ SQL Query
                                              â”‚
                                              â–¼
                                     Azure SQL Database
                                              â”‚
                                              â–¼
                                        Result Rows
                                              â”‚
                                              â–¼
    Question + SQL + Results â”€â†’ gpt-4.1-mini â”€â†’ AI Summary
                                              â”‚
                                              â–¼
                                    Complete Response
```

## ğŸ’° Token Flow & Cost Distribution

```
Typical Query Breakdown (6,000 total tokens):

Intent Extraction (gpt-4o-mini)
â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  10% (600 tokens)
Cost: $0.0006

SQL Generation (gpt-4.1)
â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  60% (3,600 tokens)
Cost: $0.0154

Result Formatting (gpt-4.1-mini)
â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  30% (1,800 tokens)
Cost: $0.0030

Total: $0.0190 per query
(vs $0.042 for gpt-4.1 only = 55% savings!)
```

## ğŸ¯ Model Selection Decision Tree

```
User Question Received
        â”‚
        â–¼
   [Simple query?] â”€â”€â”€Yesâ”€â”€â†’ Use gpt-5-mini for SQL
        â”‚                    (1-2 tables, basic filters)
        No                   Cost: ~$0.007 per query
        â”‚
        â–¼
   [Complex query?] â”€â”€Yesâ”€â”€â†’ Use gpt-4.1 for SQL
        â”‚                    (Multi-table joins, CTEs)
        No                   Cost: ~$0.024 per query
        â”‚
        â–¼
   [User preference]
        â”‚
        â””â”€â”€â†’ Let user choose in UI
             (Default: gpt-4.1)
```

## ğŸ—ï¸ Component Architecture

```
app_multimodel.py (Main Application)
â”‚
â”œâ”€â”€ UI Layer (Streamlit)
â”‚   â”œâ”€â”€ Sidebar
â”‚   â”‚   â”œâ”€â”€ Model Selection Radio Buttons
â”‚   â”‚   â”œâ”€â”€ Environment Status
â”‚   â”‚   â”œâ”€â”€ Schema Refresh Button
â”‚   â”‚   â””â”€â”€ Multi-Model Strategy Explanation
â”‚   â”‚
â”‚   â””â”€â”€ Main Content
â”‚       â”œâ”€â”€ Example Questions Grid
â”‚       â”œâ”€â”€ Query Input Area
â”‚       â”œâ”€â”€ Control Toggles
â”‚       â”œâ”€â”€ Run Configuration Display
â”‚       â”œâ”€â”€ Results Display
â”‚       â””â”€â”€ Cost Breakdown Panel
â”‚
â”œâ”€â”€ Multi-Model Pipeline
â”‚   â”œâ”€â”€ parse_nl_query_with_gpt4o_mini()
â”‚   â”‚   â””â”€â”€ Returns: Structured intent JSON
â”‚   â”‚
â”‚   â”œâ”€â”€ generate_reasoning_with_selected_model()
â”‚   â”‚   â””â”€â”€ Returns: High-level plan text
â”‚   â”‚
â”‚   â”œâ”€â”€ generate_sql_with_selected_model()
â”‚   â”‚   â””â”€â”€ Returns: T-SQL query string
â”‚   â”‚
â”‚   â””â”€â”€ format_results_with_gpt41_mini()
â”‚       â””â”€â”€ Returns: Natural language summary
â”‚
â”œâ”€â”€ Support Functions
â”‚   â”œâ”€â”€ _make_llm(deployment_name, max_tokens)
â”‚   â”‚   â””â”€â”€ Factory for Azure OpenAI instances
â”‚   â”‚
â”‚   â”œâ”€â”€ _accumulate_usage(stage, usage)
â”‚   â”‚   â””â”€â”€ Track tokens per stage
â”‚   â”‚
â”‚   â”œâ”€â”€ _get_pricing_for_deployment(deployment)
â”‚   â”‚   â””â”€â”€ Fetch pricing from config
â”‚   â”‚
â”‚   â””â”€â”€ _extract_usage_from_message(msg)
â”‚       â””â”€â”€ Parse token usage from response
â”‚
â”œâ”€â”€ Shared Modules (from nl2sql_standalone_Langchain/)
â”‚   â”œâ”€â”€ schema_reader.py
â”‚   â”‚   â”œâ”€â”€ get_sql_database_schema_context()
â”‚   â”‚   â””â”€â”€ refresh_schema_cache()
â”‚   â”‚
â”‚   â”œâ”€â”€ sql_executor.py
â”‚   â”‚   â””â”€â”€ execute_sql_query()
â”‚   â”‚
â”‚   â””â”€â”€ 1_nl2sql_main.py
â”‚       â”œâ”€â”€ extract_and_sanitize_sql()
â”‚       â”œâ”€â”€ _format_table()
â”‚       â””â”€â”€ _load_pricing_config()
â”‚
â””â”€â”€ Configuration
    â”œâ”€â”€ Environment Variables (.env)
    â”œâ”€â”€ Pricing Config (azure_openai_pricing_updated_oct2025.json)
    â””â”€â”€ Model Constants (INTENT_MODEL, SQL_MODEL_DEFAULT, etc.)
```

## ğŸ” Security & Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Environment Variables (from .env)                          â”‚
â”‚  â€¢ AZURE_OPENAI_API_KEY (encrypted in transit)             â”‚
â”‚  â€¢ AZURE_OPENAI_ENDPOINT                                    â”‚
â”‚  â€¢ AZURE_SQL_PASSWORD (encrypted in transit)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Streamlit App (runs locally or in secure environment)      â”‚
â”‚  â€¢ No credentials in code                                   â”‚
â”‚  â€¢ HTTPS for Azure OpenAI                                   â”‚
â”‚  â€¢ Encrypted SQL connection (TrustServerCertificate=yes)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Azure OpenAI     â”‚  â”‚  Azure SQL DB    â”‚
    â”‚  â€¢ API Key auth   â”‚  â”‚  â€¢ SQL auth      â”‚
    â”‚  â€¢ HTTPS only     â”‚  â”‚  â€¢ TLS 1.2+     â”‚
    â”‚  â€¢ Multi-region   â”‚  â”‚  â€¢ Firewall     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Performance Characteristics

```
Stage                Model           Avg Latency    Avg Tokens    Avg Cost
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Intent Extraction    gpt-4o-mini     0.5-1.5s      500-1,000     $0.0003
Reasoning (opt)      gpt-4.1         1.0-2.0s      1,000-2,000   $0.0040
SQL Generation       gpt-4.1         2.0-4.0s      2,000-4,000   $0.0150
SQL Generation       gpt-5-mini      1.0-2.0s      2,000-4,000   $0.0015
SQL Execution        Azure SQL       0.1-2.0s      N/A           N/A
Result Formatting    gpt-4.1-mini    1.0-2.0s      1,500-2,500   $0.0020
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total (gpt-4.1)                      5-10s         5,000-9,500   $0.0213
Total (gpt-5-mini)                   3-7s          5,000-9,500   $0.0078
```

## ğŸ¨ UI/UX Flow

```
User Arrives
    â”‚
    â–¼
[Example Questions] â”€â”€â”€ Click â”€â”€â”€â†’ Auto-fill query
    â”‚
    â–¼
[Type Question]
    â”‚
    â–¼
[Select SQL Model] (Sidebar)
    â”‚  â”œâ”€â†’ gpt-4.1 (accurate)
    â”‚  â””â”€â†’ gpt-5-mini (fast & cheap)
    â”‚
    â–¼
[Press Run]
    â”‚
    â”œâ”€â†’ See "Run Configuration" (models used)
    â”‚
    â”œâ”€â†’ See "Intent & Entities" (parsed by gpt-4o-mini)
    â”‚
    â”œâ”€â†’ See "Reasoning" (optional)
    â”‚
    â”œâ”€â†’ See "Generated SQL" (by selected model)
    â”‚
    â”œâ”€â†’ See "Results Table" (from Azure SQL)
    â”‚
    â”œâ”€â†’ See "AI Summary" (by gpt-4.1-mini) â­
    â”‚
    â””â”€â†’ See "Cost Breakdown" (per model)
        â”‚
        â”œâ”€â†’ Intent: $X.XX
        â”œâ”€â†’ SQL: $X.XX
        â”œâ”€â†’ Formatting: $X.XX
        â””â”€â†’ Total: $X.XX
```

## ğŸ”Œ Integration Points

```
app_multimodel.py
        â”‚
        â”œâ”€â”€â”€ LangChain (Azure OpenAI integration)
        â”‚    â”œâ”€â”€ AzureChatOpenAI class
        â”‚    â”œâ”€â”€ ChatPromptTemplate
        â”‚    â””â”€â”€ Message chain invocation
        â”‚
        â”œâ”€â”€â”€ Azure OpenAI API
        â”‚    â”œâ”€â”€ Endpoint: AZURE_OPENAI_ENDPOINT
        â”‚    â”œâ”€â”€ API Key: AZURE_OPENAI_API_KEY
        â”‚    â”œâ”€â”€ API Version: 2025-04-01-preview
        â”‚    â””â”€â”€ Deployments: gpt-4o-mini, gpt-4.1, gpt-5-mini, gpt-4.1-mini
        â”‚
        â”œâ”€â”€â”€ Azure SQL Database
        â”‚    â”œâ”€â”€ Server: AZURE_SQL_SERVER
        â”‚    â”œâ”€â”€ Database: CONTOSO-FI
        â”‚    â”œâ”€â”€ Driver: ODBC Driver 18
        â”‚    â””â”€â”€ Protocol: TLS 1.2+
        â”‚
        â”œâ”€â”€â”€ File System
        â”‚    â”œâ”€â”€ Schema Cache: DATABASE_SETUP/schema_cache.json
        â”‚    â”œâ”€â”€ Pricing Config: azure_openai_pricing_updated_oct2025.json
        â”‚    â””â”€â”€ Run Logs: RESULTS/nl2sql_multimodel_run_*.txt
        â”‚
        â””â”€â”€â”€ Azure Blob Storage (Optional)
             â”œâ”€â”€ Connection String: AZURE_STORAGE_CONNECTION_STRING
             â”œâ”€â”€ Container: nl2sql-logs
             â””â”€â”€ Upload: Run logs for durable storage
```

---

## ğŸ“ˆ Scalability Considerations

### Horizontal Scaling
- âœ… Stateless app (no session affinity needed)
- âœ… Each instance independent
- âœ… Load balancer compatible

### Vertical Scaling
- âœ… Low memory footprint (~100MB per instance)
- âœ… CPU usage minimal (mostly I/O wait)
- âœ… Can run on small VMs

### Cost Scaling
- âœ… Linear with query volume
- âœ… Multi-model reduces cost growth
- âœ… Predictable pricing model

---

This architecture enables **cost-optimized, high-quality NL2SQL** by using the right model for each task!
